document.addEventListener("DOMContentLoaded", () => {
  initDropdowns();
  initDistrictsDropdown();
  initGlobalCloseHandlers();
  initRoomCheckboxes();
  initPriceInput();

  function initDropdowns() {
    const dropdowns = document.querySelectorAll(".dropdown-list");

    dropdowns.forEach((dropdown) => {
      if (dropdown.classList.contains("districts-dropdown")) return;

      const textEl = dropdown.querySelector(".dropdown-list__text");
      const wrapper = dropdown.querySelector(".dropdown-list__wrapper");
      const hiddenInput = dropdown.querySelector(".dropdown-list__input");
      const items = dropdown.querySelectorAll(".dropdown-list__dropdown-item");

      if (!textEl || !wrapper) return;

      dropdown.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdown.classList.toggle("active");
        wrapper.classList.toggle("active");
      });

      items.forEach((item) => {
        item.addEventListener("click", (e) => {
          const insideHeader = dropdown.closest("header");

          if (!insideHeader) e.preventDefault();
          e.stopPropagation();

          const value = item.dataset.type || item.dataset.city || item.textContent.trim();

          textEl.textContent = value;

          if (hiddenInput) {
            hiddenInput.value = value;
          }

          wrapper.classList.remove("active");
          dropdown.classList.remove("active");
        });
      });
    });
  }

  function initGlobalCloseHandlers() {
    document.addEventListener("click", () => {
      document.querySelectorAll(".dropdown-list.active").forEach((dropdown) => {
        dropdown.classList.remove("active");
      });
      document.querySelectorAll(".dropdown-list__wrapper.active").forEach((wrapper) => {
        wrapper.classList.remove("active");
      });
    });
  }

  function initRoomCheckboxes() {
    const roomItems = document.querySelectorAll(".filter__room");

    roomItems.forEach((room) => {
      const checkbox = room.querySelector("input[type='checkbox']");
      if (!checkbox) return;

      room.addEventListener("click", (e) => {
        e.preventDefault();

        checkbox.checked = !checkbox.checked;
        room.classList.toggle("active", checkbox.checked);
      });
    });
  }

  function initPriceInput() {
    const priceInput = document.querySelector(".filter__price-input");
    const priceField = document.querySelector(".filter__price-field");

    if (!priceInput || !priceField) return;

    priceInput.addEventListener("focus", () => {
      priceField.classList.add("active");
    });

    priceInput.addEventListener("blur", () => {
      if (priceInput.value.trim() === "") {
        priceField.classList.remove("active");
      }
    });

    priceInput.addEventListener("input", () => {
      formatPrice(priceInput);
    });

    function formatPrice(inputEl) {
      let value = inputEl.value.replace(/\D/g, "");

      if (value === "") {
        inputEl.value = "";
        return;
      }

      value = value.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
      inputEl.value = value;
    }
  }
  function initDistrictsDropdown() {
    const dropdown = document.querySelector(".districts-dropdown");
    if (!dropdown) return;

    const textEl = dropdown.querySelector(".dropdown-list__text");
    const wrapper = dropdown.querySelector(".dropdown-list__wrapper");
    const hiddenInput = dropdown.querySelector(".districts-input");
    const items = dropdown.querySelectorAll(".district-item");

    dropdown.addEventListener("click", (e) => {
      e.stopPropagation();
      dropdown.classList.toggle("active");
      wrapper.classList.toggle("active");
    });

    items.forEach((item) => {
      const checkbox = item.querySelector("input[type='checkbox']");

      item.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();

        checkbox.checked = !checkbox.checked;
        item.classList.toggle("active", checkbox.checked);

        updateDistrictText();
        updateDistrictInput();
      });
    });

    function updateDistrictText() {
      const checked = dropdown.querySelectorAll(".district-item input:checked");

      if (checked.length === 0) {
        textEl.textContent = "Районы";
      } else if (checked.length === 1) {
        textEl.textContent = checked[0].value;
      } else {
        textEl.textContent = `${checked.length} выбрано`;
      }
    }

    function updateDistrictInput() {
      const checked = dropdown.querySelectorAll(".district-item input:checked");
      const values = [...checked].map((c) => c.value);
      hiddenInput.value = values.join(",");
    }
  }
});
